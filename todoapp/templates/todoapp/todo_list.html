{% extends "base.html" %}
{% block title %}My Todo Board{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">My Todo List</h2>
  <div class="d-flex gap-3 justify-content-between" id="task-board">
    {% for status, label in status_labels %}
    <div class="status-column border rounded p-3 flex-fill" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="{{ status }}">
      <h5 class="text-center mb-2">{{ label }}</h5>
      <hr>
      <div id="{{ status }}" class="task-container">
        {% for todo in todos %}
          {% if todo.status == status %}
          <div class="task card p-2 mb-2"
             id="task-{{ todo.id }}"
             draggable="true"
             ondragstart="drag(event)">

          {% if todo.image %}
            <img src="{{ todo.image.url }}" alt="{{ todo.title }}"
                 draggable="false"
                 class="img-fluid rounded mb-2"
                 style="border: none; padding: 0;">
          {% endif %}
            
          <strong>{{ todo.title }}</strong>
            <hr class="mt-1 mb-1">
          <p class="mb-1">{{ todo.description }}</p>
          <small class="text-muted">{{ todo.created_at|date:"d M Y, H:i" }}</small>
        </div>

          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4 mb-5">
    <a href="{% url 'todo_create' %}" class="btn btn-success">Add New Todo</a>
  </div>
</div>

<style>
  .status-column {
    min-height: 400px;
    background-color: #f8f9fa;
    border-radius: 10px;
    width: 32%;
    flex: none !important;
  }

  .task {
    cursor: grab;
  }

  .task-container {
    min-height: 200px;
  }

  #task-board {
    display: flex;
    justify-content: space-between;
  }
</style>

<script>
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
  }

  function drop(ev) {
    ev.preventDefault();
    const taskId = ev.dataTransfer.getData("text");
    const taskElement = document.getElementById(taskId);
    const newStatus = ev.currentTarget.getAttribute("data-status");

    ev.currentTarget.querySelector(".task-container").appendChild(taskElement);

    fetch("{% url 'update_status' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({
        task_id: taskId.replace("task-", ""),
        new_status: newStatus
      }),
    });
  }
</script>
{% endblock %}
