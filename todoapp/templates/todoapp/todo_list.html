{% extends "base.html" %}
{% block title %}My Todo Board{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">My Todo List</h2>
  <div class="d-flex gap-3 justify-content-between" id="task-board">
    {% for status, label in status_labels %}
    <div class="status-column border rounded p-3 flex-fill" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="{{ status }}">
      <h5 class="text-center mb-2">{{ label }}</h5>
      <hr>
      <div id="{{ status }}" class="task-container">
        {% for todo in todos %}
          {% if todo.status == status %}
            <div class="task card p-2 mb-2
              {% if todo.status == 'done' %}
                  border border-success bg-success-subtle
              {% else %}
                  {% if todo.deadline_status == 'overdue' %}
                      border border-danger bg-danger-subtle
                  {% elif todo.deadline_status == 'urgent' %}
                      border border-orange bg-orange-subtle
                  {% elif todo.deadline_status == 'upcoming' %}
                      border border-warning bg-warning-subtle
                  {% endif %}
              {% endif %}"
            id="task-{{ todo.id }}"
            data-deadline="{{ todo.deadline|date:'c' }}"
            data-status="{{ todo.status }}"
            draggable="true"
            ondragstart="drag(event)">
              {% if todo.image %}
                <img src="{{ todo.image.url }}" alt="{{ todo.title }}"
                     draggable="false"
                     class="img-fluid rounded mb-2"
                     style="border: none; padding: 0;">
              {% endif %}

              <strong>{{ todo.title }}</strong>
              <hr class="mt-1 mb-1">
              <p class="mb-1">{{ todo.description }}</p>

              {% if todo.deadline %}
                <div class="text-muted small">üïí Due: {{ todo.deadline|date:"d M Y, H:i" }}</div>
              {% endif %}

              <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">{{ todo.created_at|date:"d M Y, H:i" }}</small>
                <form method="POST" action="{% url 'todo_delete' todo.id %}" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="bin-button" title="Delete">üóëÔ∏è</button>
                </form>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4 mb-5">
    <a href="{% url 'todo_create' %}" class="btn btn-success">Add New Todo</a>
  </div>
</div>

<style>
  .status-column {
    min-height: 400px;
    background-color: #f8f9fa;
    border-radius: 10px;
    width: 32%;
    flex: none !important;
  }

  .task {
    cursor: grab;
  }

  .task-container {
    min-height: 200px;
  }

  #task-board {
    display: flex;
    justify-content: space-between;
  }

  .bin-button {
    border: 1px solid lightgray;
    background-color: transparent;
    padding: 4px 6px;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    color: #555;
  }

  .bin-button:hover {
    border-color: #dc3545;
    color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
    cursor: pointer;
  }

  .bg-warning-subtle {
    background-color: #fff3cd !important;
  }

  .bg-orange-subtle {
    background-color: #ffe5b4 !important;  /* light orange */
  }

  .border-orange {
    border: 1px solid #ffa500 !important;  /* orange border */
  }

  .bg-success-subtle {
    background-color: #d1e7dd !important;  /* soft green */
  }

  .bg-danger-subtle {
    background-color: #f8d7da !important;  /* soft red */
  }
</style>

<script>
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
  }

  function drop(ev) {
    ev.preventDefault();
    const taskId = ev.dataTransfer.getData("text");
    const taskElement = document.getElementById(taskId);
    const newStatus = ev.currentTarget.getAttribute("data-status");

    ev.currentTarget.querySelector(".task-container").appendChild(taskElement);

    // ‚úÖ Update the data-status attribute
    taskElement.dataset.status = newStatus;

    // ‚úÖ Recalculate color based on new status
    updateTaskColors();


    fetch("{% url 'update_status' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({
        task_id: taskId.replace("task-", ""),
        new_status: newStatus
      }),
    });
  }
</script>

<script>
function updateTaskColors() {
  const tasks = document.querySelectorAll(".task");
  const now = new Date();

  tasks.forEach(task => {
    const deadlineStr = task.dataset.deadline;
    const status = task.dataset.status;

    if (!deadlineStr) return;

    const deadline = new Date(deadlineStr);
    task.classList.remove("border-danger", "bg-danger-subtle",
                          "border-warning", "bg-warning-subtle",
                          "border-success", "bg-success-subtle",
                          "border-orange", "bg-orange-subtle");

    if (status === 'done') {
      task.classList.add("border-success", "bg-success-subtle");
    } else {
      const diff = deadline - now;
      const dayMs = 24 * 60 * 60 * 1000;

      if (diff < 0) {
        task.classList.add("border-danger", "bg-danger-subtle");
      } else if (diff < dayMs) {
        task.classList.add("border-orange", "bg-orange-subtle");
      } else if (diff < 3 * dayMs) {
        task.classList.add("border-warning", "bg-warning-subtle");
      }
    }
  });
}

// Run initially
updateTaskColors();

// Rerun every minute to update near-deadline tasks automatically
setInterval(updateTaskColors, 10000);
</script>

{% endblock %}
